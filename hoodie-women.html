<script type="module">
  import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.module.js';
  import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.160.1/examples/jsm/loaders/GLTFLoader.js';

  const colorMap = {
    red: "#ff0000",
    blue: "#0000ff",
    black: "#000000",
    white: "#ffffff"
  };

  const modelViewer = document.getElementById("hoodieModel");
  const colorCircles = document.querySelectorAll(".color-circle");
  const textInput = document.getElementById("textInput");
  const applyTextBtn = document.getElementById("applyText");

  function hexToRgba(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    const r = ((bigint >> 16) & 255) / 255;
    const g = ((bigint >> 8) & 255) / 255;
    const b = (bigint & 255) / 255;
    return [r, g, b, 1];
  }

  async function changeColor(colorName) {
    const hex = colorMap[colorName];
    const rgba = hexToRgba(hex);
    await modelViewer.updateComplete;
    const material = modelViewer.model?.materials[0];
    if (material) {
      material.pbrMetallicRoughness.setBaseColorFactor(rgba);
    }
  }

  colorCircles.forEach(circle => {
    circle.addEventListener("click", () => {
      colorCircles.forEach(c => c.classList.remove("selected"));
      circle.classList.add("selected");
      const selectedColor = circle.getAttribute("data-color");
      changeColor(selectedColor);
    });
  });

  applyTextBtn.addEventListener("click", () => {
    const text = textInput.value;
    if (!text) return;

    // ساخت تکسچر با متن
    const canvas = document.createElement("canvas");
    canvas.width = 512;
    canvas.height = 512;
    const ctx = canvas.getContext("2d");

    // زمینه سفید
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // نوشتن متن وسط بوم
    ctx.fillStyle = "#000000";
    ctx.font = "bold 40px Vazirmatn";
    ctx.textAlign = "center";
    ctx.fillText(text, canvas.width / 2, canvas.height / 2);

    const texture = new THREE.CanvasTexture(canvas);

    // استفاده از WebGL context داخلی model-viewer برای اعمال متریال جدید
    modelViewer.addEventListener("load", () => {
      const material = modelViewer.model?.materials[0];
      if (material) {
        material.pbrMetallicRoughness.baseColorTexture = texture;
      }
    });

    // بازسازی مجدد مدل برای اینکه texture جدید اعمال بشه
    modelViewer.src = modelViewer.src;
  });
</script>
