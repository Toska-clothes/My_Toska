<script type="module">
  const modelViewer = document.getElementById("hoodieModel");
  const colorCircles = document.querySelectorAll(".color-circle");
  const textInput = document.getElementById("textInput");
  const applyTextBtn = document.getElementById("applyText");

  const colorMap = {
    red: "#ff0000",
    blue: "#0000ff",
    black: "#000000",
    white: "#ffffff"
  };

  function hexToRgba(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    const r = ((bigint >> 16) & 255) / 255;
    const g = ((bigint >> 8) & 255) / 255;
    const b = (bigint & 255) / 255;
    return [r, g, b, 1];
  }

  async function changeColor(colorName) {
    const hex = colorMap[colorName];
    const rgba = hexToRgba(hex);
    await modelViewer.updateComplete;
    const material = modelViewer.model?.materials[0];
    if (material) {
      material.pbrMetallicRoughness.setBaseColorFactor(rgba);
    }
  }

  colorCircles.forEach(circle => {
    circle.addEventListener("click", () => {
      colorCircles.forEach(c => c.classList.remove("selected"));
      circle.classList.add("selected");
      const selectedColor = circle.getAttribute("data-color");
      changeColor(selectedColor);
    });
  });

  applyTextBtn.addEventListener("click", async () => {
    const text = textInput.value.trim();
    if (!text) return;

    await modelViewer.updateComplete;

    const { THREE } = modelViewer;
    const scene = modelViewer.scene;

    // حذف متن قبلی اگر وجود دارد
    const existingText = scene.getObjectByName("customText");
    if (existingText) {
      scene.remove(existingText);
    }

    const loader = new THREE.FontLoader();
    loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function (font) {
      const geometry = new THREE.TextGeometry(text, {
        font: font,
        size: 0.1,
        height: 0.02,
        curveSegments: 12,
      });

      const material = new THREE.MeshBasicMaterial({ color: 0x222222 });
      const mesh = new THREE.Mesh(geometry, material);
      mesh.name = "customText";

      // موقعیت متن روی لباس (مثلاً روی سینه)
      mesh.position.set(0, 1.3, 0.4); // اینجا را برای محل دقیق می‌توانید تنظیم کنید
      mesh.rotation.y = Math.PI; // متن رو به دوربین

      scene.add(mesh);
    });
  });
</script>
